name: E2E Tests

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

concurrency:
  group: e2e-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: hmcts
          POSTGRES_HOST_AUTH_METHOD: trust
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U hmcts -d postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

      redis:
        image: redis:8-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

    env:
      # Application configuration
      BASE_URL: https://localhost:8080
      PORT: 8080
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

      # Database Configuration (using service containers)
      DATABASE_URL: postgresql://hmcts@localhost:5432/postgres
      REDIS_URL: redis://localhost:6379

      # SSO Configuration (using existing GitHub Secrets)
      SSO_CLIENT_ID: ${{ secrets.SSO_CLIENT_ID }}
      SSO_CLIENT_SECRET: ${{ secrets.SSO_CLIENT_SECRET }}
      SSO_IDENTITY_METADATA: ${{ secrets.SSO_ISSUER_URL }}
      SSO_SYSTEM_ADMIN_GROUP_ID: ${{ secrets.SSO_SG_SYSTEM_ADMIN }}
      SSO_INTERNAL_ADMIN_CTSC_GROUP_ID: ${{ secrets.SSO_SG_ADMIN_CTSC }}
      SSO_INTERNAL_ADMIN_LOCAL_GROUP_ID: ${{ secrets.SSO_SG_ADMIN_LOCAL }}
      SSO_ALLOW_HTTP_REDIRECT: false

      # Test user credentials (using existing GitHub Secrets)
      SSO_TEST_SYSTEM_ADMIN_EMAIL: ${{ secrets.SSO_TEST_SYSTEM_ADMIN_ACCOUNT_USER }}
      SSO_TEST_SYSTEM_ADMIN_PASSWORD: ${{ secrets.SSO_TEST_SYSTEM_ADMIN_ACCOUNT_PWD }}
      SSO_TEST_LOCAL_ADMIN_EMAIL: ${{ secrets.SSO_TEST_ADMIN_LOCAL_ACCOUNT_USER }}
      SSO_TEST_LOCAL_ADMIN_PASSWORD: ${{ secrets.SSO_TEST_ADMIN_LOCAL_ACCOUNT_PWD }}
      SSO_TEST_CTSC_ADMIN_EMAIL: ${{ secrets.SSO_TEST_ADMIN_ACCOUNT_CTSC_USER }}
      SSO_TEST_CTSC_ADMIN_PASSWORD: ${{ secrets.SSO_TEST_ADMIN_ACCOUNT_CTSC_PWD }}
      SSO_TEST_NO_ROLES_EMAIL: ${{ secrets.SSO_TEST_NO_ROLES_ACCOUNT_USER }}
      SSO_TEST_NO_ROLES_PASSWORD: ${{ secrets.SSO_TEST_NO_ROLES_ACCOUNT_PWD }}

      # CFT IDAM Configuration
      ENABLE_CFT_IDAM: true
      CFT_IDAM_URL: https://idam-web-public.aat.platform.hmcts.net
      CFT_IDAM_CLIENT_SECRET: ${{ secrets.CFT_IDAM_CLIENT_SECRET }}

      # CFT IDAM Test Credentials
      CFT_VALID_TEST_ACCOUNT: ${{ secrets.CFT_VALID_TEST_ACCOUNT }}
      CFT_VALID_TEST_ACCOUNT_PASSWORD: ${{ secrets.CFT_VALID_TEST_ACCOUNT_PASSWORD }}
      CFT_INVALID_TEST_ACCOUNT: ${{ secrets.CFT_INVALID_TEST_ACCOUNT }}
      CFT_INVALID_TEST_ACCOUNT_PASSWORD: ${{ secrets.CFT_INVALID_TEST_ACCOUNT_PASSWORD }}

      # API Authentication Configuration (for blob ingestion endpoint)
      AZURE_TENANT_ID: ${{ secrets.APP_TENANT_ID }}
      AZURE_API_CLIENT_ID: ${{ secrets.APP_PIP_DATA_MANAGEMENT_ID }}
      AZURE_API_CLIENT_SECRET: ${{ secrets.APP_PIP_DATA_MANAGEMENT_PWD }}
      APP_PIP_DATA_MANAGEMENT_SCOPE: ${{ secrets.APP_PIP_DATA_MANAGEMENT_SCOPE }}

      # GOV.UK Notify Configuration (for notification E2E tests)
      GOVUK_NOTIFY_API_KEY: ${{ secrets.GOVUK_NOTIFY_API_KEY }}
      GOVUK_NOTIFY_TEMPLATE_ID_SUBSCRIPTION: ${{ secrets.GOVUK_NOTIFY_TEMPLATE_ID_SUBSCRIPTION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24.14.0'

      - name: Cache Yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL service to be ready
        run: timeout 30 bash -c 'until pg_isready -h localhost -p 5432 -U hmcts; do sleep 1; done'

      - name: Collate Prisma schema
        run: |
          echo "Collating Prisma schema from all modules..."
          cd apps/postgres && npx tsx src/collate-schema.ts && cd ../..

      - name: Generate Prisma client
        run: yarn db:generate

      - name: Run database migrations
        run: yarn db:migrate

      - name: Seed test database
        run: |
          echo "Running seed script..."
          yarn workspace @hmcts/postgres run seed
          echo "Seed script completed"

      - name: Verify seed data exists
        run: |
          echo "Verifying seed data for locationId=9..."
          ARTEFACT_COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM artefact WHERE location_id = '9';")
          ARTEFACT_COUNT=$(echo $ARTEFACT_COUNT | xargs)
          echo "Found $ARTEFACT_COUNT artefacts for locationId=9"
          if [ "$ARTEFACT_COUNT" -lt 3 ]; then
            echo "ERROR: Expected at least 3 seeded artefacts, found $ARTEFACT_COUNT"
            exit 1
          fi
          echo "âœ“ Seed data verification successful"

      - name: Build packages
        run: yarn build

      - name: Generate self-signed certificates for CI
        run: |
          chmod +x ./scripts/generate-ci-certs.sh
          ./scripts/generate-ci-certs.sh

      - name: Restore Playwright browsers cache
        uses: actions/cache/restore@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('e2e-tests/package.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: yarn workspace e2e-tests run playwright install chromium --with-deps

      - name: Install Playwright system dependencies (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: yarn workspace e2e-tests run playwright install-deps chromium

      - name: Save Playwright browsers cache
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('e2e-tests/package.json') }}

      - name: Run E2E tests
        id: e2e-tests
        run: |
          # Capture all output including server logs
          set -o pipefail
          yarn workspace e2e-tests run test:e2e 2>&1 | tee e2e-server-logs.txt

      # Publish test results to PR checks
      - name: Test Report
        id: test-report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: E2E Test Results
          path: e2e-tests/junit-results.xml
          reporter: java-junit
          fail-on-error: false

      # Upload artifacts on failure for debugging   
      - name: Upload Playwright test results
        uses: actions/upload-artifact@v6
        if: always() && steps.e2e-tests.outcome == 'failure'
        with:
          name: playwright-test-results
          path: |
            e2e-tests/test-results/
            e2e-tests/playwright-report/
          retention-days: 7

      # Upload application logs on failure for debugging
      - name: Upload application logs
        uses: actions/upload-artifact@v6
        if: always() && steps.e2e-tests.outcome == 'failure'
        with:
          name: application-logs
          path: e2e-server-logs.txt
          retention-days: 7

      # Publish test results as a PR comment
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && github.event_name == 'pull_request'
        with:
          files: e2e-tests/junit-results.xml
          check_name: E2E Test Results
          comment_title: ðŸŽ­ Playwright E2E Test Results
          fail_on: nothing