name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Get PR information
        if: github.event.issue.pull_request
        id: get-pr
        uses: actions/github-script@v8
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return pr.data;

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLAUDE_CODE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_CODE_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.issue.pull_request && fromJSON(steps.get-pr.outputs.result).head.repo.full_name || github.repository }}
          ref: ${{ github.event.issue.pull_request && fromJSON(steps.get-pr.outputs.result).head.ref || github.ref }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 1

      - name: Configure Git
        run: |
          git config user.name "claude-code-bot[bot]"
          git config user.email "claude-code-bot[bot]@users.noreply.github.com"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn db:generate

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          prompt: |
            REPO: ${{ github.repository }}
            PR/ISSUE: ${{ github.event.issue.number || github.event.pull_request.number }}

            ${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}
          claude_args: |
            --dangerously-skip-permissions
            --append-system-prompt "You are running in a GitHub Action. The environment has been set up and yarn install has been run. You can use bash and yarn commands. Read @CLAUDE.md. Run yarn format, yarn lint and yarn test before committing changes. IMPORTANT: After committing, you MUST push the changes using 'git push'."
            --allowedTools "Bash(corepack:*),Bash(yarn:*),Bash(git:*)"

  claude-plan:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@plan')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLAUDE_CODE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_CODE_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 1

      - name: Configure Git
        run: |
          git config user.name "claude-code-bot[bot]"
          git config user.email "claude-code-bot[bot]@users.noreply.github.com"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn db:generate

      - name: Run Claude Code - Plan
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE: ${{ github.event.issue.number }}
            ISSUE_TITLE: ${{ github.event.issue.title }}

            Run the /qk-plan skill for this issue. This will:
            1. Read the issue details and create a technical implementation plan
            2. Create a branch named feature/${{ github.event.issue.number }}-<short-description>
            3. Commit plan files to docs/tickets/${{ github.event.issue.number }}/
            4. Post any clarifying questions as a comment on the issue
            5. Push the branch with the plan

            Issue body:
            ${{ github.event.issue.body }}

            Comment that triggered this:
            ${{ github.event.comment.body }}
          claude_args: |
            --dangerously-skip-permissions
            --append-system-prompt "You are running in a GitHub Action for planning. Read @CLAUDE.md. Create a technical plan for the issue. Create a feature branch, commit plan files to docs/tickets/<issue-number>/, and push. Post clarifying questions as issue comments."
            --allowedTools "Bash(corepack:*),Bash(yarn:*),Bash(git:*)"

  claude-ready:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@ready')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    env:
      PROJECT_ID: PVT_kwDOAVwpV84BNDg2
      STATUS_FIELD_ID: PVTSSF_lADOAVwpV84BNDg2zg8KRxo
      REFINED_TICKETS_OPTION_ID: '378f3770'
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLAUDE_CODE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_CODE_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 1

      - name: Configure Git
        run: |
          git config user.name "claude-code-bot[bot]"
          git config user.email "claude-code-bot[bot]@users.noreply.github.com"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma Client
        run: yarn db:generate

      - name: Run Claude Code - Ready
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE: ${{ github.event.issue.number }}
            ISSUE_TITLE: ${{ github.event.issue.title }}

            The issue is being marked as ready for implementation. Please:
            1. Review any existing technical plan in docs/tickets/${{ github.event.issue.number }}/
            2. Update the plan based on any new comments or clarifications in the issue
            3. Commit any plan updates and push

            Issue body:
            ${{ github.event.issue.body }}

            Comment that triggered this:
            ${{ github.event.comment.body }}
          claude_args: |
            --dangerously-skip-permissions
            --append-system-prompt "You are running in a GitHub Action for finalizing plans. Read @CLAUDE.md. Review and update the technical plan based on issue comments. Commit and push any updates."
            --allowedTools "Bash(corepack:*),Bash(yarn:*),Bash(git:*)"

      - name: Update GitHub Project Status
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Get the project item ID for this issue
          ITEM_ID=$(gh api graphql -f query='
            query($org: String!, $number: Int!, $projectNumber: Int!) {
              organization(login: $org) {
                repository(name: "'${{ github.event.repository.name }}'") {
                  issue(number: $number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          number
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f org="${{ github.repository_owner }}" -F number=${{ github.event.issue.number }} -F projectNumber=43 --jq '.data.organization.repository.issue.projectItems.nodes[] | select(.project.number == 43) | .id')

          if [ -n "$ITEM_ID" ]; then
            # Update the status to "Refined Tickets"
            gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            ' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$STATUS_FIELD_ID" -f optionId="$REFINED_TICKETS_OPTION_ID"
            echo "Updated issue status to 'Refined Tickets' in project"
          else
            echo "Issue not found in project 43, skipping status update"
          fi

  claude-spec:
    if: |
      github.event_name == 'issue_comment' &&
      !github.event.issue.pull_request &&
      contains(github.event.comment.body, '@spec') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLAUDE_CODE_APP_ID }}
          private-key: ${{ secrets.CLAUDE_CODE_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Parse template type
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          COMMENT="$COMMENT_BODY"
          # Extract template name after @spec (default: new-feature)
          if [[ "$COMMENT" =~ @spec[[:space:]]+([a-zA-Z0-9_-]+) ]]; then
            TEMPLATE="${BASH_REMATCH[1]}"
          else
            TEMPLATE="new-feature"
          fi

          # Validate template exists
          if [[ -f "templates/$TEMPLATE.md" ]]; then
            echo "template=$TEMPLATE" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "template=$TEMPLATE" >> $GITHUB_OUTPUT
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Post error if template not found
        if: steps.parse.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const templates = fs.readdirSync('templates').join(', ');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå Template \`${{ steps.parse.outputs.template }}\` not found.\n\nAvailable templates: ${templates}\n\nUsage: \`@spec [template-name]\``
            });

      - name: Run Claude Code for spec generation
        if: steps.parse.outputs.valid == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          prompt: |
            Generate a technical specification for this GitHub issue using the specified template.

            ## Template
            Read the template from: templates/${{ steps.parse.outputs.template }}.md

            ## Issue Details
            Issue #${{ github.event.issue.number }}
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            ## Instructions
            1. Read the template file from templates/${{ steps.parse.outputs.template }}.md
            2. Read .claude/rules/design.md for GOV.UK Design System guidance
            3. Search the codebase for similar implementations to understand existing patterns
            4. Fill in ALL sections of the template with specific, actionable content based on the issue
            5. Replace all placeholder text [in brackets] with real content
            6. For wireframes, use ASCII art diagrams
            7. Post the completed specification as a comment on issue #${{ github.event.issue.number }} using:
               gh issue comment ${{ github.event.issue.number }} --body "<specification>"

            Do not create files, make commits, or modify anything.
          claude_args: |
            --allowedTools "Read,Glob,Grep,Bash(gh issue comment:*)"
            --append-system-prompt "You are generating a technical specification. After generating the spec, use 'gh issue comment' to post it to the issue. Do not create files, make commits, or modify anything."