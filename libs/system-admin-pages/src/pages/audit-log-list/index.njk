{% extends "layouts/base-template.njk" %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/date-input/macro.njk" import govukDateInput %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}

{% block backLink %}
  <a href="/system-admin-dashboard" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l" id="top">{{ title }}</h1>
  </div>
</div>

<div class="govuk-grid-row">
  <!-- Filter Panel -->
  <div class="govuk-grid-column-one-quarter">
    <div style="border: 1px solid #b1b4b6;">

      {# Filter Panel Title #}
      <div class="govuk-!-padding-4" style="background-color: #d8d8d8; border-bottom: 1px solid #b1b4b6;">
        <h2 class="govuk-heading-m govuk-!-margin-bottom-0">{{ filters_heading }}</h2>
      </div>

      {# Selected Filters Section #}
      <div class="govuk-!-padding-4 govuk-!-margin-bottom-0" style="background-color: #f3f2f1; border-bottom: 1px solid #b1b4b6;">
        <h3 class="govuk-heading-s govuk-!-margin-bottom-3">{{ selectedFiltersText }}</h3>
        <a href="/audit-log-list" class="govuk-link">{{ clearFiltersText }}</a>
        {% if filters.email or filters.userId or filters.day or filters.actions.length > 0 %}
          <div class="filter-tags govuk-!-margin-top-4">
            {% if filters.email %}
              <span class="filter-tag" style="max-width: 100%; word-break: break-word;">
                Email: {{ filters.email }}
                <a href="/audit-log-list?userId={{ filters.userId }}&day={{ filters.day }}&month={{ filters.month }}&year={{ filters.year }}{% for action in filters.actions %}&actions={{ action }}{% endfor %}" class="filter-tag-remove" aria-label="Remove email filter">×</a>
              </span>
            {% endif %}
            {% if filters.userId %}
              <span class="filter-tag">
                User ID: {{ filters.userId }}
                <a href="/audit-log-list?email={{ filters.email }}&day={{ filters.day }}&month={{ filters.month }}&year={{ filters.year }}{% for action in filters.actions %}&actions={{ action }}{% endfor %}" class="filter-tag-remove" aria-label="Remove user ID filter">×</a>
              </span>
            {% endif %}
            {% if filters.day %}
              <span class="filter-tag">
                Date: {{ filters.day }}/{{ filters.month }}/{{ filters.year }}
                <a href="/audit-log-list?email={{ filters.email }}&userId={{ filters.userId }}{% for action in filters.actions %}&actions={{ action }}{% endfor %}" class="filter-tag-remove" aria-label="Remove date filter">×</a>
              </span>
            {% endif %}
            {% for action in filters.actions %}
              <span class="filter-tag">
                {{ action | replace("_", " ") | title }}
                <a href="/audit-log-list?email={{ filters.email }}&userId={{ filters.userId }}&day={{ filters.day }}&month={{ filters.month }}&year={{ filters.year }}{% for a in filters.actions %}{% if a != action %}&actions={{ a }}{% endif %}{% endfor %}" class="filter-tag-remove" aria-label="Remove {{ action | replace('_', ' ') | title }} filter">×</a>
              </span>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {# Filter Controls Section #}
      <div class="govuk-!-padding-4">
        <form method="get" action="/audit-log-list">
          {{ govukButton({
            text: applyFiltersText
          }) }}

        {{ govukInput({
          id: "email",
          name: "email",
          label: {
            text: emailLabel,
            classes: "govuk-!-font-weight-bold"
          },
          value: filters.email,
          errorMessage: errors.email if errors
        }) }}

        {{ govukInput({
          id: "userId",
          name: "userId",
          label: {
            text: userIdLabel,
            classes: "govuk-!-font-weight-bold"
          },
          hint: {
            text: userIdHint
          },
          value: filters.userId,
          errorMessage: errors.userId if errors
        }) }}

        {{ govukDateInput({
          id: "date",
          namePrefix: "",
          formGroup: {
            classes: "app-date-filter-narrow"
          },
          fieldset: {
            legend: {
              text: dateLabel,
              classes: "govuk-!-font-weight-bold"
            }
          },
          hint: {
            text: dateHint
          },
          errorMessage: errors.date if errors,
          items: [
            {
              name: "day",
              classes: "govuk-input--width-2",
              label: dayLabel,
              value: filters.day
            },
            {
              name: "month",
              classes: "govuk-input--width-2",
              label: monthLabel,
              value: filters.month
            },
            {
              name: "year",
              classes: "govuk-input--width-4",
              label: yearLabel,
              value: filters.year
            }
          ]
        }) }}

        {% if availableActions.length > 0 %}
          {% set actionItems = [] %}
          {% for action in availableActions %}
            {% set actionItems = (actionItems.push({
              value: action.value,
              text: action.text,
              checked: filters.actions.includes(action.value)
            }), actionItems) %}
          {% endfor %}
          {{ govukCheckboxes({
            name: "actions",
            formGroup: {
              classes: "govuk-!-padding-top-4"
            },
            fieldset: {
              legend: {
                text: actionsLabel,
                classes: "govuk-!-font-weight-bold"
              }
            },
            items: actionItems
          }) }}
        {% else %}
          <div class="govuk-form-group">
            <label class="govuk-label govuk-!-font-weight-bold">{{ actionsLabel }}</label>
            <p class="govuk-body-s">No actions available yet</p>
          </div>
        {% endif %}
        </form>
      </div>

    </div>
  </div>

  <!-- Main Content -->
  <div class="govuk-grid-column-three-quarters">
    {% if errorList %}
      {{ govukErrorSummary({
        titleText: "There is a problem",
        errorList: errorList
      }) }}
    {% endif %}

    {% if logs.length > 0 %}
      {% set tableRows = [] %}
      {% for log in logs %}
        {% set tableRows = (tableRows.push([
          { text: log.timestamp },
          { text: log.userEmail },
          { text: log.action },
          { html: '<a href="/audit-log-detail?id=' + log.id + '" class="govuk-link">' + viewLinkText + '</a>' }
        ]), tableRows) %}
      {% endfor %}

      {{ govukTable({
        head: [
          { text: timestampHeader },
          { text: emailHeader },
          { text: actionHeader },
          { text: viewHeader }
        ],
        rows: tableRows
      }) }}

      {% if totalPages > 1 %}
        <nav class="govuk-pagination" aria-label="Pagination">
          {% if currentPage > 1 %}
            <div class="govuk-pagination__prev">
              <a class="govuk-link govuk-pagination__link" href="/audit-log-list?page={{ currentPage - 1 }}&email={{ filters.email }}&userId={{ filters.userId }}&day={{ filters.day }}&month={{ filters.month }}&year={{ filters.year }}{% for action in filters.actions %}&actions={{ action }}{% endfor %}" rel="prev">
                <svg class="govuk-pagination__icon govuk-pagination__icon--prev" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                  <path d="m6.5938-0.0078125-6.7266 6.7266 6.7441 6.4062 1.377-1.449-4.1856-3.9768h12.896v-2h-12.984l4.2931-4.293-1.414-1.414z"></path>
                </svg>
                <span class="govuk-pagination__link-title">Previous</span>
              </a>
            </div>
          {% endif %}

          {% if currentPage < totalPages %}
            <div class="govuk-pagination__next">
              <a class="govuk-link govuk-pagination__link" href="/audit-log-list?page={{ currentPage + 1 }}&email={{ filters.email }}&userId={{ filters.userId }}&day={{ filters.day }}&month={{ filters.month }}&year={{ filters.year }}{% for action in filters.actions %}&actions={{ action }}{% endfor %}" rel="next">
                <span class="govuk-pagination__link-title">Next</span>
                <svg class="govuk-pagination__icon govuk-pagination__icon--next" xmlns="http://www.w3.org/2000/svg" height="13" width="15" aria-hidden="true" focusable="false" viewBox="0 0 15 13">
                  <path d="m8.107-0.0078125-1.4136 1.414 4.2926 4.293h-12.986v2h12.896l-4.1855 3.9766 1.377 1.4492 6.7441-6.4062-6.7246-6.7266z"></path>
                </svg>
              </a>
            </div>
          {% endif %}
        </nav>
      {% endif %}
    {% else %}
      <p class="govuk-body">{{ noResultsText }}</p>
    {% endif %}
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <p class="govuk-body-s govuk-!-margin-top-4">
      <a href="#top" class="govuk-link">{{ backToTopText }}</a>
    </p>
  </div>
</div>
{% endblock %}
