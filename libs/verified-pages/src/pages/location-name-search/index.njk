{% extends "layouts/base-template.njk" %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% block pageTitle %}
  {{ title }} - {{ serviceName }} - {{ govUk }}
{% endblock %}

{% block page_content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l">{{ heading }}</h1>
    <p class="govuk-body">{{ description }}</p>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-quarter filter-column">
    <div style="border: 1px solid #b1b4b6;">

      {# Filter Panel Title #}
      <div class="govuk-!-padding-4" style="background-color: #d8d8d8; border-bottom: 1px solid #b1b4b6;">
        <h2 class="govuk-heading-m govuk-!-margin-bottom-0">{{ filterHeading }}</h2>
      </div>

      {# Selected Filters Section #}
      <div class="govuk-!-padding-4 govuk-!-margin-bottom-0" style="background-color: #f3f2f1; border-bottom: 1px solid #b1b4b6;">
        <h3 class="govuk-heading-s govuk-!-margin-bottom-3">{{ selectedFiltersHeading }}</h3>
        <a href="/location-name-search" class="govuk-link">{{ clearFilters }}</a>
        {% if selectedJurisdictions.length > 0 or selectedRegions.length > 0 or selectedSubJurisdictions.length > 0 %}
          <div class="filter-tags govuk-!-margin-top-4">
            {% for i in range(0, selectedJurisdictions.length) %}
              <span class="filter-tag">
              {{ selectedJurisdictionsDisplay[i] }}
              <a href="{{ jurisdictionRemoveUrls[i] }}" class="filter-tag-remove" aria-label="Remove {{ selectedJurisdictionsDisplay[i] }} filter">×</a>
            </span>
            {% endfor %}
            {% for i in range(0, selectedSubJurisdictions.length) %}
              <span class="filter-tag">
              {{ selectedSubJurisdictionsDisplay[i] }}
              <a href="{{ subJurisdictionRemoveUrls[i] }}" class="filter-tag-remove" aria-label="Remove {{ selectedSubJurisdictionsDisplay[i] }} filter">×</a>
            </span>
            {% endfor %}
            {% for i in range(0, selectedRegions.length) %}
              <span class="filter-tag">
              {{ selectedRegionsDisplay[i] }}
              <a href="{{ regionRemoveUrls[i] }}" class="filter-tag-remove" aria-label="Remove {{ selectedRegionsDisplay[i] }} filter">×</a>
            </span>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {# Filter Controls Section #}
      <div class="govuk-!-padding-4">
        <form method="get" novalidate>
          {{ govukButton({
            text: applyFilters
          }) }}

          {# Mobile hide filters button #}
          <button type="button" class="govuk-button govuk-button--secondary mobile-filter-toggle" id="hide-filters-btn" data-module="govuk-button" style="display: none;">
            {{ hideFilters }}
          </button>

          <div class="filter-section">
            <button type="button" class="filter-section-toggle" aria-expanded="true" aria-controls="jurisdiction-section">
              <span class="filter-section-heading">{{ jurisdictionHeading }}</span>
              <span class="filter-section-icon" aria-hidden="true">▼</span>
            </button>
            <div id="jurisdiction-section" class="filter-section-content">
              {{ govukCheckboxes({
                name: "jurisdiction",
                classes: "govuk-checkboxes--small",
                items: jurisdictionItems
              }) }}

              {# Sub-jurisdiction sections #}
              {% for item in jurisdictionItems %}
                {% if subJurisdictionItemsByJurisdiction[item.jurisdictionId].length > 0 %}
                  <div class="sub-jurisdiction-section filter-section" data-parent-jurisdiction="{{ item.value }}" style="display: {% if item.checked %}block{% else %}none{% endif %};">
                    <button type="button" class="filter-section-toggle" aria-expanded="true" aria-controls="sub-section-{{ item.value }}">
                      <span class="filter-section-heading">{{ item.subJurisdictionLabel }}</span>
                      <span class="filter-section-icon" aria-hidden="true">▼</span>
                    </button>
                    <div id="sub-section-{{ item.value }}" class="filter-section-content">
                      {{ govukCheckboxes({
                        name: "subJurisdiction",
                        classes: "govuk-checkboxes--small",
                        items: subJurisdictionItemsByJurisdiction[item.jurisdictionId]
                      }) }}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="filter-section">
            <button type="button" class="filter-section-toggle" aria-expanded="true" aria-controls="region-section">
              <span class="filter-section-heading">{{ regionHeading }}</span>
              <span class="filter-section-icon" aria-hidden="true">▼</span>
            </button>
            <div id="region-section" class="filter-section-content">
              {{ govukCheckboxes({
                name: "region",
                classes: "govuk-checkboxes--small",
                items: regionItems
              }) }}
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>

  <div class="govuk-grid-column-three-quarters courts-column">
    {# Mobile filter toggle button #}
    <button type="button" class="govuk-button govuk-button--secondary mobile-filter-toggle" id="show-filters-btn" data-module="govuk-button">
      {{ showFilters }}
    </button>

    <form method="post" novalidate>
      <input type="hidden" name="_csrf" value="{{ csrfToken }}">
      <table class="govuk-table court-table">
        <tbody class="govuk-table__body">
        {% for row in tableRows %}
          <tr class="govuk-table__row">
            <td class="govuk-table__cell court-table-letter">
              {% if row.letter %}
                <span class="court-letter">{{ row.letter }}</span>
              {% endif %}
            </td>
            <td class="govuk-table__cell">
              <div class="govuk-checkboxes govuk-checkboxes--small">
                <div class="govuk-checkboxes__item">
                  <input class="govuk-checkboxes__input" id="location-{{ row.location.locationId }}" name="locationIds" type="checkbox" value="{{ row.location.locationId }}">
                  <label class="govuk-label govuk-checkboxes__label" for="location-{{ row.location.locationId }}">
                    {% if locale == "cy" %}
                      {{ row.location.welshName }}
                    {% else %}
                      {{ row.location.name }}
                    {% endif %}
                  </label>
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <h2 class="govuk-heading-m">{{ totalSelected }}</h2>
      <div class="selection-counter-box govuk-!-padding-top-3 govuk-!-padding-bottom-1 govuk-!-padding-left-2 govuk-!-padding-right-2 govuk-!-margin-bottom-4" style="background-color: #f3f2f1;">
        <p class="govuk-body"><span id="selectionCount">0</span> {{ selected }}</p>
      </div>

      {{ govukButton({
        text: continueButton,
        type: "submit"
      }) }}
    </form>

    <script nonce="{{ cspNonce }}">
      (function() {
        const checkboxes = document.querySelectorAll('input[name="locationIds"]');
        const countElement = document.getElementById('selectionCount');

        function updateCount() {
          const checkedCount = document.querySelectorAll('input[name="locationIds"]:checked').length;
          countElement.textContent = checkedCount;
        }

        checkboxes.forEach(function(checkbox) {
          checkbox.addEventListener('change', updateCount);
        });

        // Initial count
        updateCount();
      })();
    </script>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <a href="#" class="govuk-link back-to-top-link"><span aria-hidden="true">▴ </span>{{ backToTop }}</a>
  </div>
</div>

{% endblock %}
