{% extends "layouts/base-template.njk" %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% block page_content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    {% if errors %}
      {{ govukErrorSummary({
        titleText: errorSummaryTitle,
        errorList: errors
      }) }}
    {% endif %}

    <h1 class="govuk-heading-xl">{{ title }}</h1>

    {{ govukDetails({
      summaryText: accordionTitle,
      html: "<p class='govuk-body'>" + accordionContent + "</p>",
      open: true
    }) }}

    <p class="govuk-body">
      <strong>{{ listFor }} {{ list.contentDate | date }}</strong><br>
      {{ published }} {{ list.publishedAt | date }} {{ at }} {{ list.publishedAt | time12 }}
    </p>

    {{ govukDetails({
      summaryText: importantInfoTitle,
      html: "<p class='govuk-body'>" + importantInfoContent + " <a href='https://www.gov.uk/government/publications/guidance-to-staff-on-supporting-media-access-to-courts-and-tribunals/protocol-on-sharing-court-lists-registers-and-documents-with-the-media-accessible-version' class='govuk-link'>" + mediaProtocolLink + "</a></p>",
      open: true
    }) }}

    <div>
      <a href="/sjp-press-list/download?artefactId={{ list.artefactId }}{% if filters.searchQuery %}&search={{ filters.searchQuery }}{% endif %}{% if filters.postcodes %}{% for pc in filters.postcodes %}&postcode={{ pc }}{% endfor %}{% endif %}{% if filters.prosecutors %}{% for p in filters.prosecutors %}&prosecutor={{ p }}{% endfor %}{% endif %}" class="govuk-button govuk-!-margin-top-4" data-module="govuk-button">
        {{ downloadButton }}
      </a>
    </div>

    <div>
      <button type="button" class="govuk-button govuk-button--secondary govuk-!-margin-top-2" data-module="govuk-button" id="filter-toggle">
        {% if filters.searchQuery or (filters.postcodes and filters.postcodes.length > 0) or (filters.prosecutors and filters.prosecutors.length > 0) %}{{ hideFilters }}{% else %}{{ showFilters }}{% endif %}
      </button>
    </div>

    {% if pagination.totalPages > 1 %}
    <nav class="govuk-pagination govuk-!-margin-top-4 govuk-!-margin-bottom-4" role="navigation" aria-label="Pagination">
      {% if pagination.hasPrevious %}
        <div class="govuk-pagination__prev">
          <a class="govuk-link govuk-pagination__link" href="?artefactId={{ list.artefactId }}&page={{ pagination.currentPage - 1 }}{% if filters.searchQuery %}&search={{ filters.searchQuery }}{% endif %}{% if filters.postcodes %}{% for pc in filters.postcodes %}&postcode={{ pc }}{% endfor %}{% endif %}{% if filters.prosecutors %}{% for p in filters.prosecutors %}&prosecutor={{ p }}{% endfor %}{% endif %}">
            <span class="govuk-pagination__link-label">{{ previous }}</span>
          </a>
        </div>
      {% endif %}

      <ul class="govuk-pagination__list">
        {% for pageNum in pagination.pageNumbers %}
          <li class="govuk-pagination__item {% if pageNum === pagination.currentPage %}govuk-pagination__item--current{% endif %}">
            <a class="govuk-link govuk-pagination__link" href="?artefactId={{ list.artefactId }}&page={{ pageNum }}{% if filters.searchQuery %}&search={{ filters.searchQuery }}{% endif %}{% if filters.postcodes %}{% for pc in filters.postcodes %}&postcode={{ pc }}{% endfor %}{% endif %}{% if filters.prosecutors %}{% for p in filters.prosecutors %}&prosecutor={{ p }}{% endfor %}{% endif %}" aria-label="Page {{ pageNum }}" {% if pageNum === pagination.currentPage %}aria-current="page"{% endif %}>
              {{ pageNum }}
            </a>
          </li>
        {% endfor %}
      </ul>

      {% if pagination.hasNext %}
        <div class="govuk-pagination__next">
          <a class="govuk-link govuk-pagination__link" href="?artefactId={{ list.artefactId }}&page={{ pagination.currentPage + 1 }}{% if filters.searchQuery %}&search={{ filters.searchQuery }}{% endif %}{% if filters.postcodes %}{% for pc in filters.postcodes %}&postcode={{ pc }}{% endfor %}{% endif %}{% if filters.prosecutors %}{% for p in filters.prosecutors %}&prosecutor={{ p }}{% endfor %}{% endif %}">
            <span class="govuk-pagination__link-label">{{ next }}</span>
          </a>
        </div>
      {% endif %}
    </nav>
    {% endif %}

    <div class="moj-filter-layout">
      <div class="filter-form layout-width-two-filters {% if not (filters.searchQuery or (filters.postcodes and filters.postcodes.length > 0) or (filters.prosecutors and filters.prosecutors.length > 0)) %}hidden{% endif %}" id="filter-panel">
        <form method="post" class="moj-filter-layout__filter" autocomplete="off">
          <input type="hidden" name="artefactId" value="{{ list.artefactId }}">

        <div class="moj-filter" data-module="moj-filter" style="border: 1px solid #b1b4b6;">
          <div class="moj-filter__header">
            <div class="moj-filter__header-title">
              <div class="govuk-!-padding-4" style="background-color: #d8d8d8; border-bottom: 1px solid #b1b4b6;">
                <h2 class="govuk-heading-m govuk-!-margin-bottom-0" tabindex="0">{{ filterTitle }}</h2>
              </div>
            </div>
          </div>

          {# Selected Filters Section - Always visible #}
          <div class="govuk-!-padding-4 govuk-!-margin-bottom-0" style="background-color: #f3f2f1; border-bottom: 1px solid #b1b4b6;">
            <h3 class="govuk-heading-s govuk-!-margin-bottom-3">{{ selectedFilters }}</h3>
            <a href="?artefactId={{ list.artefactId }}" class="govuk-link">{{ clearFilters }}</a>

            {% if filters.searchQuery or (filters.postcodes and filters.postcodes.length > 0) or (filters.prosecutors and filters.prosecutors.length > 0) %}
            <div class="filter-tags govuk-!-margin-top-4">
              {% if filters.searchQuery %}
                <span class="filter-tag">
                  {{ filters.searchQuery }}
                  <a href="?artefactId={{ list.artefactId }}{% if filters.postcodes %}{% for pc in filters.postcodes %}&postcode={{ pc }}{% endfor %}{% endif %}{% if filters.prosecutors %}{% for p in filters.prosecutors %}&prosecutor={{ p }}{% endfor %}{% endif %}" class="filter-tag-remove" aria-label="Remove {{ searchLabel }} filter">×</a>
                </span>
              {% endif %}

              {% if filters.postcodes and filters.postcodes.length > 0 %}
                {% for postcode in filters.postcodes %}
                  <span class="filter-tag">
                    {{ postcode }}
                    <a href="?artefactId={{ list.artefactId }}{% if filters.searchQuery %}&search={{ filters.searchQuery }}{% endif %}{% for pc in filters.postcodes %}{% if pc != postcode %}&postcode={{ pc }}{% endif %}{% endfor %}{% if filters.prosecutors %}{% for p in filters.prosecutors %}&prosecutor={{ p }}{% endfor %}{% endif %}" class="filter-tag-remove" aria-label="Remove {{ postcode }} filter">×</a>
                  </span>
                {% endfor %}
              {% endif %}

              {% if filters.prosecutors and filters.prosecutors.length > 0 %}
                {% for prosecutor in filters.prosecutors %}
                  <span class="filter-tag">
                    {{ prosecutor }}
                    <a href="?artefactId={{ list.artefactId }}{% if filters.searchQuery %}&search={{ filters.searchQuery }}{% endif %}{% if filters.postcodes %}{% for pc in filters.postcodes %}&postcode={{ pc }}{% endfor %}{% endif %}{% for p in filters.prosecutors %}{% if p != prosecutor %}&prosecutor={{ p }}{% endif %}{% endfor %}" class="filter-tag-remove" aria-label="Remove {{ prosecutor }} filter">×</a>
                  </span>
                {% endfor %}
              {% endif %}
            </div>
            {% endif %}
          </div>

          {# Filter Controls Section #}
          <div class="govuk-!-padding-4">
              {{ govukButton({
                text: applyFilters
              }) }}

              {{ govukInput({
                id: "search",
                name: "search",
                type: "text",
                label: {
                  text: searchLabel,
                  classes: "govuk-label--m"
                },
                value: filters.searchQuery,
                classes: "govuk-!-margin-bottom-4"
              }) }}

              <div class="govuk-form-group">
                <fieldset class="govuk-fieldset">
                  <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                    <h1 class="govuk-fieldset__heading">
                      <a href="javascript:;" class="govuk-link govuk-!-font-size-19" id="postcodes-anchor">{{ postcodeFilterHeading }}</a>
                      <span class="govuk-body govuk-!-font-size-19 filter-colour" id="postcodes-link">▶</span>
                    </h1>
                  </legend>
                  <div class="govuk-checkboxes govuk-checkboxes--small" id="postcodes-checkbox" data-module="govuk-checkboxes">
                    {% for area in postcodeAreas %}
                    <div class="govuk-checkboxes__item">
                      <input class="govuk-checkboxes__input" id="postcode-{{ loop.index }}" name="postcode" type="checkbox" value="{{ area }}" {% if filters.postcodes and filters.postcodes.indexOf(area) !== -1 %}checked{% endif %}>
                      <label class="govuk-label govuk-checkboxes__label" for="postcode-{{ loop.index }}">
                        {{ area }}
                      </label>
                    </div>
                    {% endfor %}
                    {% if hasLondonPostcodes %}
                    <div class="govuk-checkboxes__item">
                      <input class="govuk-checkboxes__input" id="postcode-london" name="postcode" type="checkbox" value="LONDON_POSTCODES" {% if filters.postcodes and filters.postcodes.indexOf('LONDON_POSTCODES') !== -1 %}checked{% endif %}>
                      <label class="govuk-label govuk-checkboxes__label" for="postcode-london">
                        {{ londonPostcodesLabel }}
                      </label>
                    </div>
                    {% endif %}
                  </div>
                </fieldset>
              </div>

              <div class="govuk-form-group">
                <fieldset class="govuk-fieldset">
                  <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                    <h1 class="govuk-fieldset__heading">
                      <a href="javascript:;" class="govuk-link govuk-!-font-size-19" id="prosecutor-anchor">{{ prosecutorFilterHeading }}</a>
                      <span class="govuk-body govuk-!-font-size-19 filter-colour" id="prosecutor-link">▶</span>
                    </h1>
                  </legend>
                  <div class="govuk-checkboxes govuk-checkboxes--small" id="prosecutor-checkbox" data-module="govuk-checkboxes">
                    {% for prosecutor in prosecutors %}
                    <div class="govuk-checkboxes__item">
                      <input class="govuk-checkboxes__input" id="prosecutor-{{ loop.index }}" name="prosecutor" type="checkbox" value="{{ prosecutor }}" {% if filters.prosecutors and filters.prosecutors.indexOf(prosecutor) !== -1 %}checked{% endif %}>
                      <label class="govuk-label govuk-checkboxes__label" for="prosecutor-{{ loop.index }}">
                        {{ prosecutor }}
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                </fieldset>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="layout-width-four-fifths" id="content-area">

    {% if cases.length > 0 %}
      {% for case in cases %}
        <div>
          {{ govukSummaryList({
            rows: [
              {
                key: { text: nameHeader },
                value: { text: case.name }
              },
              {
                key: { text: dobHeader },
                value: { html: (case.dateOfBirth | date) + (' (' + case.age + ')' if case.age else '') if case.dateOfBirth else '' }
              },
              {
                key: { text: referenceHeader },
                value: { text: case.reference or '' }
              },
              {
                key: { text: addressHeader },
                value: { text: case.address or '' }
              },
              {
                key: { text: prosecutorHeader },
                value: { text: case.prosecutor or '' }
              }
            ]
          }) }}
          {% for offence in case.offences %}
            <p class="govuk-body govuk-!-margin-top-3">
              {{ reportingRestrictionHeader }} - {{ offence.reportingRestriction }}<br>
              {% if offence.offenceWording %}
                {{ offence.offenceTitle }} - {{ offence.offenceWording }}
              {% else %}
                {{ offence.offenceTitle }}
              {% endif %}
            </p>
          {% endfor %}
        </div>
        {% if not loop.last %}
          <hr class="govuk-section-break govuk-section-break--visible">
        {% endif %}
      {% endfor %}

      {% else %}
        <p class="govuk-body">{{ noCasesFound }}</p>
      {% endif %}
      </div>
    </div>

    <div class="back-to-top-container">
      <a href="#" class="govuk-link" id="back-to-top">
        {{ backToTop }} ↑
      </a>
    </div>

  </div>
</div>
{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script nonce="{{ cspNonce }}">
    // Show/Hide filter panel
    const filterToggle = document.getElementById('filter-toggle');
    const filterPanel = document.getElementById('filter-panel');
    const contentArea = document.getElementById('content-area');

    if (filterToggle && filterPanel && contentArea) {
      // Initialize: check if filter panel is visible on page load
      const isFilterPanelVisible = !filterPanel.classList.contains('hidden');

      if (isFilterPanelVisible) {
        contentArea.classList.add('with-filters');
      } else {
        contentArea.classList.remove('with-filters');
      }

      filterToggle.addEventListener('click', function() {
        if (filterPanel.classList.contains('hidden')) {
          // Show filters
          filterPanel.classList.remove('hidden');
          contentArea.classList.add('with-filters');
          filterToggle.textContent = '{{ hideFilters }}';
        } else {
          // Hide filters
          filterPanel.classList.add('hidden');
          contentArea.classList.remove('with-filters');
          filterToggle.textContent = '{{ showFilters }}';
        }
      });
    }

    // Collapsible filter sections
    function setupFilterToggle(anchorId, linkId, checkboxId) {
      const anchor = document.getElementById(anchorId);
      const link = document.getElementById(linkId);
      const checkbox = document.getElementById(checkboxId);

      if (anchor && link && checkbox) {
        // Checkboxes are shown by default, rotate arrow indicator
        link.classList.add('rotated');

        anchor.addEventListener('click', function(e) {
          e.preventDefault();
          const isHidden = checkbox.style.display === 'none';
          checkbox.style.display = isHidden ? 'block' : 'none';

          // Toggle rotation class
          if (isHidden) {
            link.classList.add('rotated');
          } else {
            link.classList.remove('rotated');
          }
        });
      }
    }

    // Setup postcode and prosecutor filter toggles
    setupFilterToggle('postcodes-anchor', 'postcodes-link', 'postcodes-checkbox');
    setupFilterToggle('prosecutor-anchor', 'prosecutor-link', 'prosecutor-checkbox');

    // Back to top
    const backToTopLink = document.getElementById('back-to-top');
    if (backToTopLink) {
      backToTopLink.addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }
  </script>
{% endblock %}
